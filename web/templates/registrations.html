<!doctype html>
<html>
    <head>
        <title>{{T "registrations.title" .Lang}}</title>
        <link rel="stylesheet" href="/common.css">
        <script src="/table-filters.js"></script>
    </head>
    <body class="page-table">
        <nav class="top-nav">
            <div class="nav-container">
                <a href="/?lang={{.Lang}}" class="nav-brand">
                    <span class="logo">ü•è‚û°Ô∏èüóìÔ∏è</span>
                    <span class="brand-text">{{T "app.name" .Lang}}</span>
                </a>
                <div class="nav-links">
                    <a href="/tournaments?lang={{.Lang}}">{{T "nav.tournaments" .Lang}}</a>
                    <a href="/registrations?lang={{.Lang}}" class="active">{{T "nav.registrations" .Lang}}</a>
                </div>
                <div class="nav-actions">
                    <a href="/calendar/edit?lang={{.Lang}}">{{T "nav.access_calendar" .Lang}}</a>
                    <a href="/calendar/new?lang={{.Lang}}" class="primary">{{T "nav.create_calendar" .Lang}}</a>
                </div>
                <div class="lang-switcher">
                    <a href="?lang=de" class="lang-option{{if eq .Lang "de"}} active{{end}}">DE</a>
                    <a href="?lang=en" class="lang-option{{if eq .Lang "en"}} active{{end}}">EN</a>
                </div>
                <button class="mobile-menu-toggle" onclick="toggleMobileMenu()">‚ò∞</button>
            </div>
        </nav>
        <div class="main-content">
            <h1>{{T "registrations.title" .Lang}}</h1>
            <p class="sync-info">
                <span class="sync-indicator" id="sync-indicator"></span>
                <span id="sync-text">Last synced: {{ .LastSync }}</span>
                <span id="sync-time" data-iso="{{ .LastSyncISO }}" style="display:none;"></span>
            </p>
            <div class="filters-container">
                <div class="filters-row">
                    <div class="filter-item-wide">
                        <label class="filter-label">{{T "filter.search" .Lang}}</label>
                        <input type="text" id="filter-search" class="filter-input" placeholder="{{T "filter.search_placeholder" .Lang}}">
                    </div>

                    <div class="filter-item-wide">
                        <label class="filter-label">{{T "filter.series" .Lang}}</label>
                        <select id="filter-series-dropdown" class="filter-select-small" onchange="addSeriesFilter()">
                            <option value="">{{T "filter.series_placeholder" .Lang}}</option>
                        </select>
                        <div class="filter-tags" id="series-tags"></div>
                    </div>

                    <div class="filter-item">
                        <label class="filter-label">{{T "tournament.status" .Lang}}</label>
                        <select id="filter-status" class="filter-select">
                            <option value="all">{{T "filter.all" .Lang}}</option>
                            <option value="open">{{T "registrations.open" .Lang}}</option>
                            <option value="upcoming">{{T "registrations.upcoming" .Lang}}</option>
                        </select>
                    </div>

                    <div class="filter-item">
                        <label class="filter-label">&nbsp;</label>
                        <button id="reset-filters" class="filter-reset-btn">{{T "filter.reset_all" .Lang}}</button>
                    </div>
                </div>
            </div>

        <div class="table-container">
            <table id="registrations-table">
            <tbody>
                {{range .Open}}
                <tr data-title="{{.TournamentTitle}}" data-series="{{join .TournamentSeries ","}}" data-status="open">
                    <td>
                        {{template "date-range-with-time" (dict "Start" .RegistrationStart "End" .RegistrationEnd)}}
                        <div class="registration-status-text">
                            {{if .ClosesToday}}
                            <span class="closes-today-text">{{T "registrations.closes_today" $.Lang}} {{.RegistrationEnd.Format "15:04"}}</span>
                            {{else if .ClosesTomorrow}}
                            <span class="closes-tomorrow-text">{{T "registrations.closes_tomorrow" $.Lang}} {{.RegistrationEnd.Format "15:04"}}</span>
                            {{else if gt .DaysLeft 2}}
                            <span class="days-left-text">{{TArgs "registrations.days_left" $.Lang .DaysLeft}}</span>
                            {{end}}
                        </div>
                    </td>
                    <td>
                        <a href="/tournament/{{.TournamentId}}?lang={{$.Lang}}">{{.TournamentTitle}}</a>
                        <div class="registration-phase-name">{{.PhaseTitle}}</div>
                    </td>
                    <td>
                        <div class="badges-cell">
                            <a href="https://turniere.discgolf.de/index.php?p=events&sp=register&id={{.TournamentId}}" target="_blank" class="info-badge registration-open-badge">{{T "tournaments.registration_open" $.Lang}} <span class="link-icon">‚Üó</span></a>
                        </div>
                    </td>
                </tr>
                {{end}}
                {{if and .Open .Upcoming}}
                <tr class="registration-divider">
                    <td colspan="3">
                        <div class="divider-line"></div>
                        <div class="divider-text">{{T "registrations.upcoming" .Lang}}</div>
                    </td>
                </tr>
                {{end}}
                {{range .Upcoming}}
                <tr data-title="{{.TournamentTitle}}" data-series="{{join .TournamentSeries ","}}" data-status="upcoming">
                    <td>
                        {{template "date-range-with-time" (dict "Start" .RegistrationStart "End" .RegistrationEnd)}}
                        <div class="registration-status-text">
                            {{if .OpensToday}}
                            <span class="opens-today-text">{{T "registrations.opens_today" $.Lang}} {{.RegistrationStart.Format "15:04"}}</span>
                            {{else if .OpensTomorrow}}
                            <span class="opens-tomorrow-text">{{T "registrations.opens_tomorrow" $.Lang}} {{.RegistrationStart.Format "15:04"}}</span>
                            {{else if gt .OpensInDays 0}}
                            <span class="opens-in-days-text">{{TArgs "registrations.opens_in_days" $.Lang .OpensInDays}}</span>
                            {{end}}
                        </div>
                    </td>
                    <td>
                        <a href="/tournament/{{.TournamentId}}?lang={{$.Lang}}">{{.TournamentTitle}}</a>
                        <div class="registration-phase-name">{{.PhaseTitle}}</div>
                    </td>
                    <td>
                    </td>
                </tr>
                {{end}}
                {{if not (or .Open .Upcoming)}}
                <tr>
                    <td colspan="3" class="empty-state">
                        {{T "registrations.empty" .Lang}}
                    </td>
                </tr>
                {{end}}
            </tbody>
        </table>
        </div>
        </div>
        <script>
            function toggleMobileMenu() {
                document.querySelector('.nav-links').classList.toggle('mobile-open');
                document.querySelector('.nav-actions').classList.toggle('mobile-open');
            }

            // Translations for sync time
            const i18n = {
                justNow: '{{T "time.just_now" .Lang}}',
                minuteAgo: '{{T "time.minute_ago" .Lang}}',
                minutesAgo: '{{T "time.minutes_ago" .Lang}}',
                hourAgo: '{{T "time.hour_ago" .Lang}}',
                hoursAgo: '{{T "time.hours_ago" .Lang}}',
                dataUpdated: '{{T "time.data_updated" .Lang}}'
            };

            // Sync time display
            function updateSyncTime() {
                const syncTimeEl = document.getElementById('sync-time');
                const syncTextEl = document.getElementById('sync-text');
                const syncIndicator = document.getElementById('sync-indicator');

                if (!syncTimeEl || !syncTimeEl.dataset.iso) return;

                const syncDate = new Date(syncTimeEl.dataset.iso);
                const now = new Date();
                const diffMs = now - syncDate;
                const diffMins = Math.floor(diffMs / 60000);
                const diffHours = Math.floor(diffMins / 60);

                let relativeText;
                if (diffMins < 1) {
                    relativeText = i18n.justNow;
                    syncIndicator.className = 'sync-indicator fresh';
                } else if (diffMins === 1) {
                    relativeText = i18n.minuteAgo;
                    syncIndicator.className = 'sync-indicator fresh';
                } else if (diffMins < 60) {
                    relativeText = i18n.minutesAgo.replace('{0}', diffMins);
                    syncIndicator.className = diffMins < 30 ? 'sync-indicator fresh' : 'sync-indicator recent';
                } else if (diffHours === 1) {
                    relativeText = i18n.hourAgo;
                    syncIndicator.className = 'sync-indicator recent';
                } else if (diffHours < 24) {
                    relativeText = i18n.hoursAgo.replace('{0}', diffHours);
                    syncIndicator.className = 'sync-indicator stale';
                } else {
                    relativeText = syncDate.toLocaleDateString();
                    syncIndicator.className = 'sync-indicator stale';
                }

                syncTextEl.textContent = i18n.dataUpdated.replace('{0}', relativeText);
            }

            // Initialize table filters
            let tableFilter;
            let seriesSet;
            const selectedSeries = new Set();

            // Function to update divider visibility
            function updateDividerVisibility() {
                const divider = document.querySelector('.registration-divider');
                if (!divider) return;

                // Check if there are visible open rows
                const openRows = document.querySelectorAll('tr[data-status="open"]');
                const hasVisibleOpen = Array.from(openRows).some(row => row.style.display !== 'none');

                // Check if there are visible upcoming rows
                const upcomingRows = document.querySelectorAll('tr[data-status="upcoming"]');
                const hasVisibleUpcoming = Array.from(upcomingRows).some(row => row.style.display !== 'none');

                // Show divider only if both sections have visible rows
                divider.style.display = (hasVisibleOpen && hasVisibleUpcoming) ? '' : 'none';
            }

            document.addEventListener('DOMContentLoaded', function() {
                // Update sync time display
                updateSyncTime();
                setInterval(updateSyncTime, 60000);

                tableFilter = new TableFilter('#registrations-table');

                // Set callback to update divider after filtering
                tableFilter.onFilterChange = updateDividerVisibility;

                // Add search filter
                tableFilter.addFilter('search', {
                    value: '',
                    fn: (row, value) => {
                        if (!value) return true;
                        return row.dataset.title.toLowerCase().includes(value.toLowerCase());
                    }
                });

                // Add series filter
                tableFilter.addFilter('series', {
                    value: null,
                    fn: (row, value) => {
                        if (selectedSeries.size === 0) return true;
                        const rowSeries = row.dataset.series.split(',');
                        return Array.from(selectedSeries).some(s => rowSeries.includes(s));
                    }
                });

                // Add status filter
                tableFilter.addFilter('status', {
                    value: 'all',
                    fn: (row, value) => {
                        if (value === 'all') return true;
                        return row.dataset.status === value;
                    }
                });

                // Populate series dropdown from table data
                seriesSet = new Set();
                tableFilter.rows.forEach(row => {
                    const series = row.dataset.series;
                    if (series) {
                        series.split(',').forEach(s => {
                            if (s.trim()) seriesSet.add(s.trim());
                        });
                    }
                });
                const seriesSelect = document.getElementById('filter-series-dropdown');
                Array.from(seriesSet).sort().forEach(series => {
                    const option = document.createElement('option');
                    option.value = series;
                    option.textContent = series;
                    seriesSelect.appendChild(option);
                });

                // Event listeners
                document.getElementById('filter-search').addEventListener('input', (e) => {
                    tableFilter.setFilterValue('search', e.target.value.trim());
                });

                document.getElementById('filter-status').addEventListener('change', (e) => {
                    tableFilter.setFilterValue('status', e.target.value);
                });

                // Reset button
                document.getElementById('reset-filters').addEventListener('click', () => {
                    // Clear search
                    document.getElementById('filter-search').value = '';

                    // Clear tags
                    document.getElementById('series-tags').textContent = '';

                    // Restore all options to series dropdown
                    const seriesDropdown = document.getElementById('filter-series-dropdown');
                    while (seriesDropdown.options.length > 1) {
                        seriesDropdown.remove(1);
                    }
                    Array.from(seriesSet).sort().forEach(series => {
                        const option = document.createElement('option');
                        option.value = series;
                        option.textContent = series;
                        seriesDropdown.appendChild(option);
                    });

                    // Clear selected sets
                    selectedSeries.clear();

                    // Reset dropdowns
                    seriesDropdown.selectedIndex = 0;
                    document.getElementById('filter-status').value = 'all';

                    tableFilter.reset();
                });
            });

            // Safe helper to create filter tags without innerHTML
            function createFilterTag(displayText, onRemove) {
                const tag = document.createElement('span');
                tag.className = 'filter-tag';
                tag.appendChild(document.createTextNode(displayText + ' '));
                const btn = document.createElement('button');
                btn.type = 'button';
                btn.textContent = '√ó';
                btn.addEventListener('click', onRemove);
                tag.appendChild(btn);
                return tag;
            }

            function addSeriesFilter() {
                const dropdown = document.getElementById('filter-series-dropdown');
                const selectedOption = dropdown.options[dropdown.selectedIndex];
                const value = dropdown.value.trim();

                if (value && !selectedSeries.has(value)) {
                    selectedSeries.add(value);
                    const tagsDiv = document.getElementById('series-tags');
                    const tag = createFilterTag(value, () => removeSeriesFilter(value));
                    tagsDiv.appendChild(tag);

                    // Remove the option from dropdown
                    selectedOption.remove();
                    dropdown.selectedIndex = 0;
                    tableFilter.setFilterValue('series', true);
                }
            }

            function removeSeriesFilter(value) {
                selectedSeries.delete(value);
                updateTagDisplay('series-tags', selectedSeries, removeSeriesFilter);

                // Add the option back to dropdown
                const dropdown = document.getElementById('filter-series-dropdown');
                const option = document.createElement('option');
                option.value = value;
                option.textContent = value;

                // Insert in sorted order
                const options = Array.from(dropdown.options).slice(1); // Skip first placeholder
                options.push(option);
                options.sort((a, b) => a.value.localeCompare(b.value));

                // Clear and rebuild
                while (dropdown.options.length > 1) {
                    dropdown.remove(1);
                }
                options.forEach(opt => dropdown.add(opt));

                tableFilter.setFilterValue('series', true);
            }

            function updateTagDisplay(tagsDivId, selectedSet, removeFn) {
                const tagsDiv = document.getElementById(tagsDivId);
                tagsDiv.textContent = '';
                selectedSet.forEach(value => {
                    const tag = createFilterTag(value, () => removeFn(value));
                    tagsDiv.appendChild(tag);
                });
            }
        </script>
    </body>
</html>
